<div class="comment-section">
  <h3 class="comment-title">Bình luận ({{ comments.length }})</h3>

  <!-- Form thêm comment mới -->
  <div class="comment-form" *ngIf="currentUser">
    <div class="comment-input-wrapper">
      <textarea
        [(ngModel)]="newComment"
        placeholder="Viết bình luận của bạn..."
        class="comment-input"
        rows="3"
      ></textarea>
      <button class="btn-submit" (click)="submitComment()" [disabled]="!newComment.trim()">
        Gửi
      </button>
    </div>
  </div>

  <div class="login-prompt" *ngIf="!currentUser">
    <p>Vui lòng <a routerLink="/login">đăng nhập</a> để bình luận</p>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading">
    Đang tải bình luận...
  </div>

  <!-- Danh sách comments -->
  <div class="comments-list" *ngIf="!loading">
    <div *ngIf="comments.length === 0" class="no-comments">
      Chưa có bình luận nào. Hãy là người đầu tiên bình luận!
    </div>

    <div *ngFor="let comment of comments" class="comment-item">
      <div class="comment-header">
        <div class="comment-author">
          <div class="avatar" [style.background-image]="comment.avatar ? 'url(' + comment.avatar + ')' : 'none'">
            <span *ngIf="!comment.avatar">{{ comment.username.charAt(0).toUpperCase() }}</span>
          </div>
          <div class="author-info">
            <span class="username">{{ comment.username }}</span>
            <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
          </div>
        </div>
        <div class="comment-actions">
          <button 
            class="btn-like" 
            (click)="toggleLike(comment.id)"
            [class.liked]="comment.isLiked"
            title="Thích"
          >
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 14L3 9V4C3 3.44772 3.44772 3 4 3H6L7 5H12C12.5523 5 13 5.44772 13 6V9L8 14Z" 
                    [attr.fill]="comment.isLiked ? 'currentColor' : 'none'" 
                    stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <span *ngIf="comment.likes && comment.likes > 0">{{ comment.likes }}</span>
          </button>
          <button 
            class="btn-reply" 
            (click)="startReply(comment.id)"
            *ngIf="currentUser"
          >
            Trả lời
          </button>
          <button 
            class="btn-delete" 
            (click)="deleteComment(comment.id)"
            *ngIf="currentUser && (currentUser.id === comment.userId || currentUser.email === comment.userId)"
          >
            Xóa
          </button>
        </div>
      </div>

      <div class="comment-content">
        {{ comment.content }}
      </div>

      <!-- Form reply -->
      <div class="reply-form" *ngIf="replyingTo === comment.id">
        <textarea
          [(ngModel)]="replyContent"
          placeholder="Viết phản hồi..."
          class="reply-input"
          rows="2"
        ></textarea>
        <div class="reply-actions">
          <button class="btn-cancel" (click)="cancelReply()">Hủy</button>
          <button class="btn-submit-reply" (click)="submitReply(comment.id)" [disabled]="!replyContent.trim()">
            Gửi
          </button>
        </div>
      </div>

      <!-- Replies -->
      <div class="replies" *ngIf="comment.replies && comment.replies.length > 0">
        <div *ngFor="let reply of comment.replies" class="reply-item">
          <div class="comment-header">
            <div class="comment-author">
              <div class="avatar small" [style.background-image]="reply.avatar ? 'url(' + reply.avatar + ')' : 'none'">
                <span *ngIf="!reply.avatar">{{ reply.username.charAt(0).toUpperCase() }}</span>
              </div>
              <div class="author-info">
                <span class="username">{{ reply.username }}</span>
                <span class="comment-date">{{ formatDate(reply.createdAt) }}</span>
              </div>
            </div>
            <div class="comment-actions">
              <button 
                class="btn-like" 
                (click)="toggleLike(reply.id)"
                [class.liked]="reply.isLiked"
                title="Thích"
              >
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                  <path d="M8 14L3 9V4C3 3.44772 3.44772 3 4 3H6L7 5H12C12.5523 5 13 5.44772 13 6V9L8 14Z" 
                        [attr.fill]="reply.isLiked ? 'currentColor' : 'none'" 
                        stroke="currentColor" stroke-width="1.5"/>
                </svg>
                <span *ngIf="reply.likes && reply.likes > 0">{{ reply.likes }}</span>
              </button>
              <button 
                class="btn-delete" 
                (click)="deleteComment(reply.id)"
                *ngIf="currentUser && (currentUser.id === reply.userId || currentUser.email === reply.userId)"
              >
                Xóa
              </button>
            </div>
          </div>
          <div class="comment-content">
            {{ reply.content }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

